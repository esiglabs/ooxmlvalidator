{"version":3,"sources":["../src/index.js"],"names":["pkijs","asn1js","xmlcore","xmldsigjs","xadesjs","pvutils","jszip","eslutils","extractTimestamp","signedXml","UnsignedProperties","sigTimeStamp","UnsignedSignatureProperties","items","forEach","item","localName","encTimeStamp","EncapsulatedTimeStamp","asn1","fromBER","Value","buffer","contentInfo","ContentInfo","schema","result","ex","validationData","GetElement","certEls","getElementsByTagNameNS","certificates","i","length","pem","textContent","certDer","stringToArrayBuffer","fromBase64","cert","Certificate","push","loadContentTypes","zip","Promise","resolve","then","file","async","xmlDoc","Parse","cont","types","getElementsByTagName","undefined","defaults","overrides","defaultEls","Array","prototype","slice","call","extension","el","getAttribute","contentType","overrideEls","part","getContentType","filename","contentTypes","override","split","pop","def","validateFile","hashAlgo","hash","transforms","crypto","getCrypto","digest","doc","trans","name","relsEl","rels","finalRels","id","rel","type","data","ids","indexOf","parentNode","removeChild","hasAttributeNS","setAttributeNS","sort","a","b","leftId","rightId","appendChild","transform","XmlDsigC14NTransform","LoadInnerXml","GetOutput","toString","tempBuffer","ArrayBuffer","view","Uint8Array","charCodeAt","view1","view2","res","validateSig","num","trustedSigningCAs","trustedTimestampingCAs","sigInfo","SignatureInfo","sequence","tsToken","xmlSig","SignedXml","LoadXml","signature","KeyInfo","X509CertificateList","simpl","Verify","catch","sigVerified","packageObject","obj","refs","checkList","err","uri","ref","n","params","substring","n2","param","key","algorithm","CryptoConfig","CreateHashAlgorithm","hashAlgorithm","b64Hash","transformEls","transformEl","childNodes","ooxmlns","transformData","idEls","j","idTypes","all","map","entry","hashVerified","reduce","verifyChain","truststore","signerVerified","status","hasTS","tsSigned","SignedData","content","XmlSignature","GetChild","sigValueCanon","replace","verify","signer","checkChain","extendedMode","tsVerified","signatureVerified","tsCert","signerCertificate","e","tsCertVerified","OOXMLValidator","TrustStoreList","validationInfo","ValidationInfo","fileContents","addTrustStore","removeTrustStore","loadAsync","isValid","sigs","Object","keys","files","filter","match","Error","isSigned","signatures"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * OOXML Validator module\n *\n * By Fotis Loukos <me@fotisl.com>\n * @module ooxmlvalidator\n */\nimport * as pkijs from 'pkijs';\nimport * as asn1js from 'asn1js';\nimport * as xmlcore from 'xml-core';\nimport * as xmldsigjs from 'xmldsigjs';\nimport * as xadesjs from 'xadesjs';\nimport * as pvutils from 'pvutils';\nimport * as jszip from 'jszip';\nimport * as eslutils from 'eslutils';\nimport './webcrypto';\n\n/**\n * Timestamp token and associated certificates.\n * @typedef {Object} TimestampTokenCerts\n * @property {pkijs.ContentInfo} contentInfo - The timestamp token.\n * @property {Array<pkijs.Certificate>} certificates - The associated\n * certificates.\n */\n\n/**\n * Hashing algorithm specification.\n * @typedef {Object} HashAlgorithm\n * @property {string} name - The name of the algorithm.\n */\n\n/**\n * XML transformation specification.\n * @typedef {Object} Transformation\n * @property {string} name - The type of the transformation\n * (relationshiptransform or c14n).\n * @property {Object} data - Associated data based on the transformation.\n */\n\n/**\n * Default content type for a specific extension.\n * @typedef {Object} Default\n * @property {string} extension - The extension of the file.\n * @property {string} contentType - The content type.\n */\n\n/**\n * Content type override for a specific file.\n * @typedef {Object} Override\n * @property {string} part - The name of the file.\n * @property {string} contentType - The content type.\n */\n\n/**\n * Content types contained in the OOXML file.\n * @typedef {Object} ContentTypes\n * @property {Array<Default>} defaults - The default content types based on the\n * extension of the file.\n * @property {Array<Override>} overrides - Overrides for specific files.\n */\n\n/**\n * Extract the timestamp from a signature.\n * @param {SignedXml} signedXml - The signed XML.\n * @return {TimestampTokenCerts} The signature and signing cert, or null if no\n * timestamp exists.\n */\nfunction extractTimestamp(signedXml) {\n  if(!('UnsignedProperties' in signedXml) ||\n    !('UnsignedSignatureProperties' in signedXml.UnsignedProperties))\n    return null\n\n  let sigTimeStamp;\n  signedXml.UnsignedProperties.UnsignedSignatureProperties.items\n    .forEach(item => {\n      if(item.localName === 'SignatureTimeStamp')\n        sigTimeStamp = item;\n    });\n\n  if(typeof sigTimeStamp === 'undefined')\n    return null;\n\n  if(!('EncapsulatedTimeStamp' in sigTimeStamp))\n    return null;\n\n  let encTimeStamp;\n  sigTimeStamp.EncapsulatedTimeStamp.items.forEach(item => {\n    if(item.localName === 'EncapsulatedTimeStamp')\n      encTimeStamp = item;\n  });\n\n  if(typeof encTimeStamp === 'undefined')\n    return null;\n\n  const asn1 = asn1js.fromBER(encTimeStamp.Value.buffer);\n\n  let contentInfo;\n  try {\n    contentInfo = new pkijs.ContentInfo({ schema: asn1.result });\n  } catch(ex) {\n    return null;\n  }\n\n  let validationData;\n  try {\n    validationData = signedXml.UnsignedProperties.UnsignedSignatureProperties\n      .GetElement('TimeStampValidationData')\n  } catch(ex) {\n    return null;\n  }\n\n  const certEls = validationData.getElementsByTagNameNS(\n    'http://uri.etsi.org/01903/v1.3.2#', 'EncapsulatedX509Certificate');\n  const certificates = [];\n  for(let i = 0; i < certEls.length; i++) {\n    const pem = certEls[i].textContent;\n    const certDer = pvutils.stringToArrayBuffer(pvutils.fromBase64(pem));\n    const asn1 = asn1js.fromBER(certDer);\n    const cert = new pkijs.Certificate({ schema: asn1.result });\n    certificates.push(cert);\n  }\n\n  return {\n    contentInfo,\n    certificates\n  };\n}\n\n/**\n * Load and parse content types.\n * @param {JSZip} zip - The OOXML file.\n * @return {Promise<ContentTypes>} A promise that is resolved with an object\n * containing all the necessary content type information.\n */\nfunction loadContentTypes(zip) {\n  return Promise.resolve().then(() => {\n    return zip.file('[Content_Types].xml').async('string');\n  }).then(cont => {\n    const xmlDoc = xmlcore.Parse(cont);\n    const types = xmlDoc.getElementsByTagName('Types');\n\n    if(types.length !== 1)\n      return undefined;\n\n    const defaults = [];\n    const overrides = [];\n\n    const defaultEls = Array.prototype.slice.call(\n      types[0].getElementsByTagName('Default'));\n    defaultEls.forEach(el => {\n      defaults.push({\n        extension: el.getAttribute('Extension'),\n        contentType: el.getAttribute('ContentType')\n      });\n    });\n\n    const overrideEls = Array.prototype.slice.call(\n      types[0].getElementsByTagName('Override'));\n    overrideEls.forEach(el => {\n      overrides.push({\n        part: el.getAttribute('PartName'),\n        contentType: el.getAttribute('ContentType')\n      });\n    });\n\n    return {\n      defaults,\n      overrides\n    }\n  });\n}\n\n/**\n * Find the content type of a file.\n * @param {string} filename - The filename.\n * @param {ContentTypes} contentTypes - The OOXML content types as a\n * ContentTypes object.\n * @return {string} The filename's content type.\n */\nfunction getContentType(filename, contentTypes) {\n  let contentType;\n\n  contentTypes.overrides.forEach(override => {\n    if(override.part === filename)\n      contentType = override.contentType;\n  });\n\n  if(typeof contentType !== 'undefined')\n    return contentType;\n\n  const extension = filename.split('.').pop();\n\n  contentTypes.defaults.forEach(def => {\n    if(def.extension === extension)\n      contentType = def.contentType;\n  });\n\n  return contentType;\n}\n\n/**\n * Validate the hash of a file.\n * @param {JSZip} zip - The OOXML file.\n * @param {string} filename - The filename.\n * @param {HashAlgorithm} hashAlgo - The hash algorithm.\n * @param {ArrayBuffer} hash - The expected hash of the file.\n * @param {Array<Transformation>} transforms - The transforms to be applied to\n * the file.\n * @return {Promise<boolean>} A promise that is resolved with true if the\n * hash has validated, otherwise false.\n */\nfunction validateFile(zip, filename, hashAlgo, hash, transforms) {\n  return Promise.resolve().then(() => {\n    if(filename[0] === '/')\n      filename = filename.slice(1);\n\n    if(transforms.length === 0)\n      return zip.file(filename).async('uint8array');\n    else\n      return zip.file(filename).async('string');\n  }).then(cont => {\n    const crypto = pkijs.getCrypto();\n\n    if(transforms.length === 0)\n      return crypto.digest(hashAlgo, cont);\n\n    const xmlDoc = xmlcore.Parse(cont, 'application/xml');\n    let doc;\n\n    transforms.forEach(trans => {\n      if(trans.name === 'relationshiptransform') {\n        const relsEl = xmlDoc.getElementsByTagName('Relationships')[0];\n        const rels = Array.prototype.slice.call(\n          relsEl.getElementsByTagName('Relationship'));\n\n        const finalRels = [];\n        rels.forEach(rel => {\n          const id = rel.getAttribute('Id');\n          const type = rel.getAttribute('Type');\n\n          if((trans.data.ids.indexOf(id) === -1) &&\n            (trans.data.types.indexOf(type) === -1)) {\n            rel.parentNode.removeChild(rel);\n          } else {\n            // We must add TargetMode with the default value Internal if no\n            // such attribute exists\n            if(!rel.hasAttributeNS(undefined, 'TargetMode'))\n              rel.setAttributeNS(undefined, 'TargetMode', 'Internal');\n            finalRels.push(rel);\n          }\n        });\n\n        finalRels.sort((a, b) => {\n          const leftId = a.getAttribute('Id');\n          const rightId = b.getAttribute('Id');\n\n          if(leftId === rightId)\n            return 0;\n          if(leftId < rightId)\n            return -1;\n          return 1;\n        });\n\n        finalRels.forEach(rel => relsEl.appendChild(rel));\n      } else if(trans.name === 'c14n') {\n        // We assume c14n is always the last transformation.\n        const transform = new xmldsigjs.XmlDsigC14NTransform();\n        transform.LoadInnerXml(xmlDoc);\n        doc = transform.GetOutput();\n      }\n    });\n\n    if(typeof doc === 'undefined')\n      doc = xmlDoc.toString();\n\n    const tempBuffer = new ArrayBuffer(doc.length);\n    const view = new Uint8Array(tempBuffer);\n\n    for(let i = 0; i < doc.length; i++)\n      view[i] = doc.charCodeAt(i);\n\n    return crypto.digest(hashAlgo, tempBuffer);\n  }).then(res => {\n    const view1 = new Uint8Array(hash);\n    const view2 = new Uint8Array(res);\n\n    if(view1.length !== view2.length)\n      return false;\n\n    for(let i = 0; i < view1.length; i++) {\n      if(view1[i] !== view2[i])\n        return false;\n    }\n\n    return true;\n  });\n}\n\n/**\n * Validate a single signature.\n * @param {JSZip} zip - The OOXML file.\n * @param {integer} num - The number of the signature.\n * @param {eslutils.TrustStoreList} trustedSigningCAs - Trusted document\n * signing CAs.\n * @param {eslutils.TrustStoreList} trustedTimestampingCAs - Trusted document\n * timestamping CAs.\n * @return {Promise<eslutils.SignatureInfo>} A promise that is resolved with a\n * SignatureInfo object containing information about the signature.\n */\nfunction validateSig(zip, num, trustedSigningCAs, trustedTimestampingCAs) {\n  const sigInfo = new eslutils.SignatureInfo(num);\n  let sequence = Promise.resolve();\n  let xmlDoc, signedXml, tsToken, contentTypes;\n\n  sequence = sequence.then(() => loadContentTypes(zip)).then(result => {\n    contentTypes = result;\n  }).then(() => {\n    return zip.file(`_xmlsignatures/sig${num}.xml`).async('string');\n  }).then(cont => {\n    xmlDoc = xadesjs.Parse(cont, 'application/xml');\n    const xmlSig = xmlDoc.getElementsByTagNameNS(\n      'http://www.w3.org/2000/09/xmldsig#', 'Signature');\n    signedXml = new xadesjs.SignedXml(xmlDoc);\n    signedXml.LoadXml(xmlSig[0]);\n\n    sigInfo.cert = signedXml.signature.KeyInfo.items[0]\n      .X509CertificateList[0].simpl;\n\n    return signedXml.Verify();\n  }).then(res => {\n    return res;\n  }).catch(e => {\n    return false;\n  }).then(res => {\n    sigInfo.sigVerified = res;\n\n    let packageObject;\n    Array.prototype.slice.call(xmlDoc.getElementsByTagName('Object'))\n      .forEach(obj => {\n        if(obj.getAttribute('Id') === 'idPackageObject')\n          packageObject = obj;\n      });\n\n    if(typeof packageObject === 'undefined')\n      return [ false ];\n\n    const refs = Array.prototype.slice.call(\n      packageObject.getElementsByTagName('Reference'));\n    const checkList = [];\n    let err = false;\n    refs.forEach(ref => {\n      if(err === true)\n        return;\n      let uri = ref.getAttribute('URI');\n      const n = uri.indexOf('?');\n      let contentType;\n\n      if(n !== -1) {\n        const params = uri.substring(n + 1);\n        uri = uri.substring(0, n);\n        params.split('&').forEach(param => {\n          const n2 = param.indexOf('=');\n          const key = param.substring(0, n2);\n          if(key === 'ContentType')\n            contentType = param.substring(n2 + 1);\n        });\n      } else {\n        err = true;\n        return;\n      }\n\n      if(typeof contentType === 'undefined') {\n        err = true;\n        return;\n      }\n\n      if(getContentType(uri, contentTypes) !== contentType) {\n        err = true;\n        return;\n      }\n\n      const algorithm = xmldsigjs.CryptoConfig.CreateHashAlgorithm(ref\n        .getElementsByTagName('DigestMethod')[0].getAttribute('Algorithm'))\n        .algorithm;\n\n      // We assume the same algorithm is used for all files\n      sigInfo.hashAlgorithm = algorithm.name;\n\n      const b64Hash = ref.getElementsByTagName('DigestValue')[0].textContent;\n      const hash = pvutils.stringToArrayBuffer(pvutils.fromBase64(b64Hash));\n\n      const transforms = [];\n      const transformEls = Array.prototype.slice.call(\n        ref.getElementsByTagName('Transforms'));\n      transformEls.forEach(transformEl => {\n        for(let i = 0; i < transformEl.childNodes.length; i++) {\n          const transform = transformEl.childNodes[i];\n          const ooxmlns = 'http://schemas.openxmlformats.org/package/2006';\n          if(transform.getAttribute('Algorithm') ===\n            `${ooxmlns}/RelationshipTransform`) {\n            const transformData = {\n              ids: [],\n              types: []\n            };\n\n            const idEls = transform.getElementsByTagNameNS(\n              `${ooxmlns}/digital-signature`, 'RelationshipReference');\n            for(let j = 0; j < idEls.length; j++)\n              transformData.ids.push(idEls[j].getAttribute('SourceId'));\n\n            const idTypes = transform.getElementsByTagNameNS(\n              `${ooxmlns}/digital-signature`, 'RelationshipsGroupReference');\n            for(let j = 0; j < idTypes.length; j++)\n              transformData.types.push(idTypes[j].getAttribute('SourceType'));\n\n            transforms.push({\n              name: 'relationshiptransform',\n              data: transformData\n            });\n          } else if(transform.getAttribute('Algorithm') ===\n            'http://www.w3.org/TR/2001/REC-xml-c14n-20010315') {\n            transforms.push({\n              name: 'c14n'\n            });\n          } else {\n            err = true;\n          }\n        }\n      });\n\n      checkList.push({\n        uri,\n        algorithm,\n        hash,\n        transforms\n      });\n    });\n    if(err === true)\n      return [ false ];\n\n    return Promise.all(checkList.map(entry =>\n      validateFile(zip, entry.uri, entry.algorithm, entry.hash,\n        entry.transforms)));\n  }).then(res => {\n    sigInfo.hashVerified = res.reduce((a, b) => a && b);\n  });\n\n  trustedSigningCAs.forEach(truststore => {\n    sequence = sequence.then(() => eslutils.verifyChain(sigInfo.cert, [],\n      truststore.certificates)).then(result => {\n      sigInfo.signerVerified.push({\n        name: truststore.name,\n        status: result\n      });\n    });\n  });\n\n  sequence = sequence.then(() => {\n    tsToken = extractTimestamp(signedXml);\n    if(tsToken !== null) {\n      sigInfo.hasTS = true;\n\n      const tsSigned = new pkijs.SignedData({\n        schema: tsToken.contentInfo.content\n      });\n\n      const transform = new xmldsigjs.XmlDsigC14NTransform();\n      transform.LoadInnerXml(signedXml.XmlSignature.GetChild('SignatureValue'));\n      let sigValueCanon = transform.GetOutput();\n      // According to https://www.w3.org/TR/REC-xml/#sec-line-ends, parsers\n      // should convert any EOL to \\n. This fixes a bug in an older xmldsig\n      // version.\n      sigValueCanon = sigValueCanon.replace(/&#xD;/g, '');\n\n      return tsSigned.verify({\n        signer: 0,\n        data: pvutils.stringToArrayBuffer(sigValueCanon),\n        checkChain: false,\n        extendedMode: true\n      });\n    } else {\n      return false;\n    }\n  }).then(result => {\n    if(tsToken !== null) {\n      sigInfo.tsVerified = result.signatureVerified;\n      sigInfo.tsCert = result.signerCertificate;\n    }\n  }).catch(e => {\n    if(tsToken !== null) {\n      sigInfo.tsVerified = false;\n      sigInfo.tsCert = e.signerCertificate;\n    }\n  });\n\n  trustedTimestampingCAs.forEach(truststore => {\n    sequence = sequence.then(() => {\n      if(tsToken !== null)\n        return eslutils.verifyChain(sigInfo.tsCert, [],\n          truststore.certificates);\n    }).then(result => {\n      if(tsToken !== null) {\n        sigInfo.tsCertVerified.push({\n          name: truststore.name,\n          status: result\n        });\n      }\n    });\n  });\n\n  return sequence.then(() => sigInfo);\n}\n\n/**\n * OOXML Validator class\n */\nexport class OOXMLValidator {\n  /**\n   * Load an OOXML file from a buffer.\n   * @param {ArrayBuffer} buffer - The buffer containing the OOXML file.\n   */\n  constructor(buffer) {\n    /**\n     * @type {eslutils.TrustStoreList}\n     * @description Trusted document signing CAs.\n     */\n    this.trustedSigningCAs = new eslutils.TrustStoreList();\n    /**\n     * @type {eslutils.TrustStoreList}\n     * @description Trusted document timestamping CAs.\n     */\n    this.trustedTimestampingCAs = new eslutils.TrustStoreList();\n    /**\n     * @type {eslutils.ValidationInfo}\n     * @description A ValidationInfo object holding the validation results.\n     */\n    this.validationInfo = new eslutils.ValidationInfo();\n    /**\n     * @type {ArrayBuffer}\n     * @description The contents of the OOXML file.\n     */\n    this.fileContents = buffer;\n    /**\n     * @type {JSZip}\n     * @description The file as a zip structure.\n     */\n    this.zip = null;\n  }\n\n  /**\n   * Add a trust store to the document signing trust stores.\n   * @param {TrustStore} truststore - The trust store to add.\n   */\n  addSigningTruststore(truststore) {\n    this.trustedSigningCAs.addTrustStore(truststore);\n  }\n\n  /**\n   * Remove a trust store from the document signing trust stores by name.\n   * @param {string} name - The name of the trust store to remove.\n   */\n  removeSigningTruststore(name) {\n    this.trustedSigningCAs.removeTrustStore(name);\n  }\n\n  /**\n   * Add a trust store to the timestamping trust stores.\n   * @param {TrustStore} truststore - The trust store to add.\n   */\n  addTimestampingTruststore(truststore) {\n    this.trustedTimestampingCAs.addTrustStore(truststore);\n  }\n\n  /**\n   * Remove a trust store from the document signing trust stores by name.\n   * @param {string} name - The name of the trust store to remove.\n   */\n  removeTimestampingTruststore(name) {\n    this.trustedTimestampingCAs.removeTrustStore(name);\n  }\n\n  /**\n   * Validate the OOXML file.\n   * @return {Promise<eslutils.ValidationInfo>} A promise that is resolved with\n   * a ValidationInfo object containing the validation results.\n   */\n  validate() {\n    let sequence = Promise.resolve();\n\n    sequence = sequence.then(() => jszip.loadAsync(this.fileContents))\n      .then(zip => {\n        this.zip = zip;\n        this.validationInfo.isValid = true;\n\n        const sigs = Object.keys(zip.files).filter(name =>\n          name.match(/_xmlsignatures\\/sig[0-9]+.xml/)).map(name =>\n          name.replace('_xmlsignatures/sig', '').replace('.xml', ''));\n        if(sigs.length === 0)\n          throw new Error('Unsigned OOXML file');\n\n        this.validationInfo.isSigned = true;\n\n        return Promise.all(sigs.map(num => validateSig(zip, num,\n          this.trustedSigningCAs, this.trustedTimestampingCAs)));\n      }, e => {\n        throw new Error('Invalid OOXML file');\n      }).then(res => {\n        this.validationInfo.signatures = res.slice();\n      }).catch(() => {});\n\n    return sequence.then(() => this.validationInfo);\n  }\n}\n"]}